<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Conteúdo Editável - Silva Tintas Automotivas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .form-input {
            @apply block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Drag and Drop Styles */
        .draggable-item {
            @apply cursor-grab;
        }
        .dragging {
            @apply opacity-40 cursor-grabbing;
        }
        .drop-zone {
            @apply bg-blue-50 border-2 border-dashed border-blue-400;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loading-spinner"></div>
        <p class="mt-4 text-gray-600">Carregando calendário...</p>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Silva Tintas Automotivas</h1>
            <p class="text-lg text-gray-600 mt-2">Calendário de Conteúdo Editável</p>
        </header>

        <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
            <div id="calendar-header" class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 id="month-year" class="text-xl sm:text-2xl font-semibold"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div id="calendar-grid-header" class="grid calendar-grid gap-2 text-center font-medium text-gray-500 text-sm mb-2">
                <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
            </div>
            <div id="calendar-grid" class="grid calendar-grid gap-2"></div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-semibold"></h3>
                <button id="close-modal" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto max-h-[70vh] modal-content">
                <form id="content-form" class="space-y-6"></form>
            </div>
            <div id="modal-footer" class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-2xl flex justify-end space-x-3"></div>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDPisgGzruxqnXzf9hPlb05uCN3hMozt2s",
            authDomain: "crm-silva-tintas.firebaseapp.com",
            projectId: "crm-silva-tintas",
            storageBucket: "crm-silva-tintas.firebasestorage.app",
            messagingSenderId: "37152653096",
            appId: "1:37152653096:web:7cf6864a5740ac94abda1d",
            measurementId: "G-KQ2N5EYNR5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        
        // --- INITIAL DATA (for first-time setup) ---
        const initialContentData = {
            "9-1": { stories: { theme: "Domingo de Relax", description: "Conteúdo leve e enquete sobre os projetos da semana." } },
            "9-2": { feed: { type: "Reel", brand: "Maxi Rubber", title: "Preparação é Tudo!", description: "Reel acelerado mostrando a correta aplicação e lixamento da massa poliéster da Maxi Rubber.", cta: "Uma base perfeita começa aqui. Linha completa Maxi Rubber na nossa loja!" }, stories: { theme: "Segunda da Técnica", description: "Dica rápida sobre catálise de massa." } },
            "9-3": { stories: { theme: "Terça Tira-Dúvidas", description: "Caixa de perguntas sobre preparação de superfície." } },
            "9-4": { feed: { type: "Carrossel", brand: "Wanda", title: "Seu Tempo Vale Ouro", description: "Carrossel comparando o tempo de ciclo de um reparo rápido usando o sistema de secagem rápida da Wanda.", cta: "Mais carros por dia, mais lucro no fim do mês. Conheça as soluções rápidas da Wanda!" }, stories: { theme: "Quarta do Cliente", description: "Mostrando um cliente buscando uma cor personalizada." } },
            // ... (rest of the initial data is omitted for brevity but would be here)
        };

        // --- GLOBAL VARIABLES ---
        let contentData = {};
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearEl = document.getElementById('month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const modal = document.getElementById('modal');
        const modalContainer = modal.querySelector('div');
        const modalTitle = document.getElementById('modal-title');
        const modalFooter = document.getElementById('modal-footer');
        const contentForm = document.getElementById('content-form');
        const closeModalBtn = document.getElementById('close-modal');
        const loadingOverlay = document.getElementById('loading-overlay');

        let currentDate = new Date();
        currentDate.setDate(1);
        let selectedDayKey = null;

        // --- DRAG AND DROP HANDLERS ---
        function handleDragStart(e) {
            const sourceKey = e.target.closest('[data-day-key]').dataset.dayKey;
            e.dataTransfer.setData('text/plain', sourceKey);
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            const targetCell = e.target.closest('[data-day-key]');
            if (targetCell) {
                targetCell.classList.add('drop-zone');
            }
        }

        function handleDragLeave(e) {
            const targetCell = e.target.closest('[data-day-key]');
            if (targetCell) {
                targetCell.classList.remove('drop-zone');
            }
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        async function handleDrop(e) {
            e.preventDefault();
            const targetCell = e.target.closest('[data-day-key]');
            if (!targetCell) return;
            
            targetCell.classList.remove('drop-zone');
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));

            const sourceKey = e.dataTransfer.getData('text/plain');
            const targetKey = targetCell.dataset.dayKey;

            if (sourceKey === targetKey || !sourceKey) return;

            const sourceData = contentData[sourceKey];
            if (!sourceData) return;

            if (contentData[targetKey]) {
                if (!confirm(`O dia de destino já possui conteúdo. Deseja combinar as informações? O conteúdo arrastado irá sobrescrever qualquer campo conflitante (feed ou stories).`)) {
                    return;
                }
            }
            
            const targetData = contentData[targetKey] || {};
            const mergedData = { ...targetData, ...sourceData };

            const docRef = doc(db, "calendars", "silva-tintas-content");
            const updatedData = { ...contentData };
            
            updatedData[targetKey] = mergedData;
            delete updatedData[sourceKey];

            try {
                loadingOverlay.style.display = 'flex';
                await setDoc(docRef, updatedData);
            } catch (error) {
                console.error("Error moving content: ", error);
                alert("Não foi possível mover o conteúdo.");
                loadingOverlay.style.display = 'none';
            }
        }

        // --- DATA HANDLING ---
        async function initializeAppLogic() {
            try {
                await signInAnonymously(auth);
                const docRef = doc(db, "calendars", "silva-tintas-content");
                
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists() && Object.keys(docSnap.data()).length > 0) {
                        contentData = docSnap.data();
                    } else {
                        console.log("No document found, creating one with initial data.");
                        contentData = initialContentData;
                        setDoc(docRef, contentData);
                    }
                    renderCalendar();
                    loadingOverlay.style.display = 'none';
                });

            } catch (error) {
                console.error("Error initializing app:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
            }
        }

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} de ${year}`;
            calendarGrid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.innerHTML += '<div class="border border-gray-200 rounded-lg"></div>';
            }

            for (let day = 1; day <= lastDateOfMonth; day++) {
                const dayKey = `${month + 1}-${day}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'border border-gray-200 rounded-lg p-2 h-28 sm:h-32 flex flex-col relative';
                dayEl.dataset.dayKey = dayKey;
                dayEl.dataset.day = day;

                // Add drop zone listeners to the day cell
                dayEl.addEventListener('dragover', handleDragOver);
                dayEl.addEventListener('dragleave', handleDragLeave);
                dayEl.addEventListener('drop', handleDrop);

                const dayNumber = document.createElement('span');
                dayNumber.className = 'font-semibold text-gray-700';
                dayNumber.textContent = day;
                dayEl.appendChild(dayNumber);
                
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayNumber.classList.add('bg-blue-500', 'text-white', 'rounded-full', 'w-7', 'h-7', 'flex', 'items-center', 'justify-center');
                }
                
                // Click listener for editing
                dayEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.draggable-item')) {
                       showModal(day, dayKey);
                    }
                });

                const content = contentData[dayKey];
                if (content && (content.feed || content.stories)) {
                    const draggableWrapper = document.createElement('div');
                    draggableWrapper.className = 'draggable-item mt-1';
                    draggableWrapper.draggable = true;
                    draggableWrapper.addEventListener('dragstart', handleDragStart);
                    draggableWrapper.addEventListener('dragend', handleDragEnd);

                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'space-y-1 overflow-hidden text-xs pointer-events-none';

                    if (content.feed && content.feed.title) {
                        const feedPill = document.createElement('div');
                        const type = content.feed.type || 'Estático';
                        feedPill.className = `flex items-center p-1 rounded-md ${type === 'Reel' ? 'bg-purple-100 text-purple-800' : type === 'Carrossel' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
                        const icon = type === 'Reel' ? '🎬' : type === 'Carrossel' ? '📑' : '🖼️';
                        feedPill.innerHTML = `<span class="mr-1">${icon}</span> <span class="font-medium truncate">${content.feed.title}</span>`;
                        contentWrapper.appendChild(feedPill);
                    }
                    if(content.stories && content.stories.theme) {
                         const storiesPill = document.createElement('div');
                         storiesPill.className = 'flex items-center p-1 rounded-md bg-pink-100 text-pink-800';
                         storiesPill.innerHTML = `<span>📱</span> <span class="ml-1 truncate">${content.stories.theme}</span>`;
                         contentWrapper.appendChild(storiesPill);
                    }
                    draggableWrapper.appendChild(contentWrapper);
                    dayEl.appendChild(draggableWrapper);
                }
                calendarGrid.appendChild(dayEl);
            }
        }
        
        function showModal(day, dayKey) {
            selectedDayKey = dayKey;
            const content = contentData[dayKey] || { feed: {}, stories: {} };
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            modalTitle.textContent = `Editar Conteúdo - ${date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' })}`;
            
            contentForm.innerHTML = `
                <div>
                    <h4 class="text-lg font-bold text-pink-600 mb-2 border-b pb-2">📱 Conteúdo dos Stories</h4>
                    <div class="space-y-4 pt-2">
                        <div><label for="stories-theme" class="form-label">Tema do Dia</label><input type="text" id="stories-theme" class="form-input" placeholder="Ex: Segunda da Técnica" value="${content.stories?.theme || ''}"></div>
                        <div><label for="stories-description" class="form-label">Descrição dos Stories</label><textarea id="stories-description" rows="2" class="form-input" placeholder="Ex: Dica rápida em vídeo, enquete...">${content.stories?.description || ''}</textarea></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-purple-600 mb-2 border-b pb-2">🎬 Conteúdo do Feed</h4>
                    <div class="space-y-4 pt-2">
                         <div><label for="feed-title" class="form-label">Título do Post</label><input type="text" id="feed-title" class="form-input" placeholder="Ex: O Segredo do Brilho Espelhado" value="${content.feed?.title || ''}"></div>
                         <div><label for="feed-type" class="form-label">Formato</label><select id="feed-type" class="form-input"><option value="Estático" ${content.feed?.type === 'Estático' ? 'selected' : ''}>Estático</option><option value="Carrossel" ${content.feed?.type === 'Carrossel' ? 'selected' : ''}>Carrossel</option><option value="Reel" ${content.feed?.type === 'Reel' ? 'selected' : ''}>Reel</option></select></div>
                         <div><label for="feed-brand" class="form-label">Marca em Destaque</label><input type="text" id="feed-brand" class="form-input" placeholder="Ex: Norton" value="${content.feed?.brand || ''}"></div>
                         <div><label for="feed-description" class="form-label">Descrição do Post</label><textarea id="feed-description" rows="3" class="form-input" placeholder="Detalhes do que será mostrado no post...">${content.feed?.description || ''}</textarea></div>
                         <div><label for="feed-cta" class="form-label">Chamada para Ação (CTA)</label><input type="text" id="feed-cta" class="form-input" placeholder="Ex: Visite nossa loja!" value="${content.feed?.cta || ''}"></div>
                    </div>
                </div>
            `;
            
            modalFooter.innerHTML = `<button id="delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none">Excluir</button><button id="save-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none">Salvar</button>`;
            document.getElementById('save-btn').addEventListener('click', saveContent);
            document.getElementById('delete-btn').addEventListener('click', deleteContent);

            modal.classList.remove('hidden');
            setTimeout(() => modalContainer.classList.remove('scale-95', 'opacity-0'), 10);
        }

        function hideModal() {
            modalContainer.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        async function saveContent() {
            const newContent = {
                stories: {
                    theme: document.getElementById('stories-theme').value.trim(),
                    description: document.getElementById('stories-description').value.trim(),
                },
                feed: {
                    title: document.getElementById('feed-title').value.trim(),
                    type: document.getElementById('feed-type').value,
                    brand: document.getElementById('feed-brand').value.trim(),
                    description: document.getElementById('feed-description').value.trim(),
                    cta: document.getElementById('feed-cta').value.trim(),
                }
            };
            
            if (!newContent.stories.theme && !newContent.stories.description) delete newContent.stories;
            if (!newContent.feed.title) delete newContent.feed;

            const docRef = doc(db, "calendars", "silva-tintas-content");
            const updatedData = { ...contentData };

            if (Object.keys(newContent).length > 0) {
                updatedData[selectedDayKey] = newContent;
            } else {
                delete updatedData[selectedDayKey];
            }
            
            try {
                await setDoc(docRef, updatedData);
                hideModal();
            } catch (error) {
                console.error("Error saving content: ", error);
                alert("Não foi possível salvar as alterações.");
            }
        }

        async function deleteContent() {
            if (confirm('Tem certeza que deseja excluir todo o conteúdo deste dia?')) {
                const docRef = doc(db, "calendars", "silva-tintas-content");
                const updatedData = { ...contentData };
                delete updatedData[selectedDayKey];
                try {
                    await setDoc(docRef, updatedData);
                    hideModal();
                } catch (error) {
                    console.error("Error deleting content: ", error);
                    alert("Não foi possível excluir o conteúdo.");
                }
            }
        }

        // --- EVENT LISTENERS ---
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        closeModalBtn.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) hideModal(); });

        // --- INITIALIZATION ---
        initializeAppLogic();
    </script>
</body>
</html>
