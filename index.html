<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Prospecção - Silva Tintas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A3D62"/>
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-nao-contatado { background-color: #e2e8f0; color: #4a5568; }
        .status-contatado { background-color: #bee3f8; color: #2b6cb0; }
        .status-em-negociacao { background-color: #faf089; color: #975a16; }
        .status-cliente { background-color: #c6f6d5; color: #2f855a; }
        .status-perdido { background-color: #fed7d7; color: #c53030; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                     <div class="bg-[#0A3D62] p-2 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-[#0A3D62]">CRM de Prospecção</h1>
                </div>
                <button id="add-client-btn" class="bg-[#0A3D62] text-white font-semibold py-2 px-4 rounded-md hover:bg-[#1E90FF] transition text-sm flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline">Adicionar Cliente</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Dashboard Stats -->
            <section id="dashboard" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <!-- Stats will be rendered here by JS -->
            </section>

            <!-- Filters and Search -->
            <section class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                <div class="grid md:grid-cols-3 gap-4 items-center">
                    <div class="md:col-span-2">
                        <label for="search" class="sr-only">Buscar Cliente</label>
                        <input type="text" id="search" placeholder="Buscar por nome do cliente..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#0A3D62] focus:border-transparent">
                    </div>
                    <div>
                        <label for="filter-segment" class="sr-only">Filtrar por Segmento</label>
                        <select id="filter-segment" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-[#0A3D62] focus:border-transparent">
                            <option value="todos">Todos os Segmentos</option>
                            <option value="Reparação Automotiva">Reparação Automotiva</option>
                            <option value="Frotas e Veículos Pesados">Frotas e Veículos Pesados</option>
                            <option value="Indústria da Madeira e Mobiliário">Indústria da Madeira</option>
                            <option value="Indústria Metalmecânica e Construção">Indústria e Construção</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Client Table -->
            <section class="bg-white rounded-lg shadow-sm overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider">Segmento</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="client-table-body">
                        <!-- Client rows will be rendered here by JS -->
                    </tbody>
                </table>
                 <div id="no-results" class="hidden text-center py-12 px-6">
                    <p class="text-gray-500">Nenhum cliente encontrado com os filtros aplicados.</p>
                </div>
            </section>
        </main>

        <!-- Modal for Client Details -->
        <div id="client-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0">
                <!-- Modal content will be rendered here by JS -->
            </div>
        </div>
        
        <!-- Modal for Adding a New Client -->
        <div id="add-client-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="add-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg transform scale-95 opacity-0">
                <form id="add-client-form" class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Adicionar Novo Cliente</h2>
                        <button type="button" id="cancel-add-btn" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="new-client-name" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="new-client-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="new-client-address" class="block text-sm font-medium text-gray-700">Endereço</label>
                            <input type="text" id="new-client-address" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="new-client-contact" class="block text-sm font-medium text-gray-700">Contato (Telefone/Email)</label>
                            <input type="text" id="new-client-contact" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="new-client-segment" class="block text-sm font-medium text-gray-700">Segmento</label>
                            <select id="new-client-segment" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
                                <option value="Reparação Automotiva">Reparação Automotiva</option>
                                <option value="Frotas e Veículos Pesados">Frotas e Veículos Pesados</option>
                                <option value="Indústria da Madeira e Mobiliário">Indústria da Madeira</option>
                                <option value="Indústria Metalmecânica e Construção">Indústria e Construção</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="bg-[#0A3D62] text-white font-bold py-2 px-4 rounded-md hover:bg-[#1E90FF] transition">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // A SUA CONFIGURAÇÃO PESSOAL DO FIREBASE VAI AQUI
        const firebaseConfig = {
          apiKey: "AIzaSyDPisgGzruxqnXzf9hPlb05uCN3hMozt2s",
          authDomain: "crm-silva-tintas.firebaseapp.com",
          projectId: "crm-silva-tintas",
          storageBucket: "crm-silva-tintas.firebasestorage.app",
          messagingSenderId: "37152653096",
          appId: "1:37152653096:web:26343eee0a516de3abda1d",
          measurementId: "G-PM419Y78GD"
        };

        // Inicializar o Firebase e o Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const clientsCollection = collection(db, "clients");

        document.addEventListener('DOMContentLoaded', () => {
            let allClients = [];

            const tableBody = document.getElementById('client-table-body');
            const searchInput = document.getElementById('search');
            const segmentFilter = document.getElementById('filter-segment');
            const dashboard = document.getElementById('dashboard');
            
            const clientModal = document.getElementById('client-modal');
            const clientModalContent = document.getElementById('modal-content');

            const addClientModal = document.getElementById('add-client-modal');
            const addClientModalContent = document.getElementById('add-modal-content');
            const addClientBtn = document.getElementById('add-client-btn');
            const addClientForm = document.getElementById('add-client-form');
            const cancelAddBtn = document.getElementById('cancel-add-btn');

            const noResultsDiv = document.getElementById('no-results');

            const statusClasses = {
                "Não contatado": "status-nao-contatado",
                "Contatado": "status-contatado",
                "Em negociação": "status-em-negociacao",
                "Cliente": "status-cliente",
                "Perdido": "status-perdido"
            };
            
            const statusOrder = {
                "Não contatado": 1,
                "Contatado": 2,
                "Em negociação": 3,
                "Cliente": 4,
                "Perdido": 5
            };
            
            // Listener em tempo real do Firestore
            onSnapshot(clientsCollection, (snapshot) => {
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable();
                renderDashboard();
            }, (error) => {
                console.error("Erro ao buscar dados: ", error);
                alert("Não foi possível carregar os dados. Verifique a sua ligação à internet e a configuração do Firebase.");
            });


            const renderDashboard = () => {
                const total = allClients.length;
                const naoContatado = allClients.filter(c => c.status === 'Não contatado').length;
                const contatado = allClients.filter(c => c.status === 'Contatado').length;
                const emNegociacao = allClients.filter(c => c.status === 'Em negociação').length;
                const cliente = allClients.filter(c => c.status === 'Cliente').length;
                
                dashboard.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <p class="text-2xl font-bold text-[#0A3D62]">${total}</p>
                        <p class="text-sm text-gray-500">Total de Leads</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <p class="text-2xl font-bold text-gray-600">${naoContatado}</p>
                        <p class="text-sm text-gray-500">Não Contatados</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <p class="text-2xl font-bold text-blue-600">${contatado}</p>
                        <p class="text-sm text-gray-500">Contatados</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <p class="text-2xl font-bold text-yellow-600">${emNegociacao}</p>
                        <p class="text-sm text-gray-500">Em Negociação</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <p class="text-2xl font-bold text-green-600">${cliente}</p>
                        <p class="text-sm text-gray-500">Clientes</p>
                    </div>
                `;
            };

            const renderTable = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedSegment = segmentFilter.value;

                const filteredClients = allClients.filter(client => {
                    const nameMatch = client.name.toLowerCase().includes(searchTerm);
                    const segmentMatch = selectedSegment === 'todos' || client.segment === selectedSegment;
                    return nameMatch && segmentMatch;
                });

                tableBody.innerHTML = '';
                
                if (filteredClients.length === 0) {
                    noResultsDiv.classList.remove('hidden');
                } else {
                    noResultsDiv.classList.add('hidden');
                }

                filteredClients
                    .sort((a, b) => statusOrder[a.status] - statusOrder[b.status] || a.name.localeCompare(b.name))
                    .forEach(client => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <p class="font-semibold text-gray-900">${client.name}</p>
                                <p class="text-sm text-gray-500">${client.address ? client.address.split(',').pop().trim() : ''}</p>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${client.segment}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="status-badge ${statusClasses[client.status]}">${client.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <button data-id="${client.id}" class="view-details-btn text-sm font-medium text-[#0A3D62] hover:text-[#1E90FF]">Detalhes</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
            };

            const openDetailsModal = (clientId) => {
                const client = allClients.find(c => c.id === clientId);
                if (!client) return;

                clientModalContent.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">${client.name}</h2>
                                <p class="text-sm text-gray-500">${client.address || ''}</p>
                                <p class="text-sm text-gray-500">${client.contact || ''}</p>
                            </div>
                            <button id="close-modal-btn" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="status-select" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="status-select" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
                                    <option value="Não contatado" ${client.status === 'Não contatado' ? 'selected' : ''}>Não contatado</option>
                                    <option value="Contatado" ${client.status === 'Contatado' ? 'selected' : ''}>Contatado</option>
                                    <option value="Em negociação" ${client.status === 'Em negociação' ? 'selected' : ''}>Em negociação</option>
                                    <option value="Cliente" ${client.status === 'Cliente' ? 'selected' : ''}>Cliente</option>
                                    <option value="Perdido" ${client.status === 'Perdido' ? 'selected' : ''}>Perdido</option>
                                </select>
                            </div>
                            <div class="self-end">
                                <button id="save-status-btn" class="w-full bg-[#0A3D62] text-white font-bold py-2 px-4 rounded-md hover:bg-[#1E90FF] transition">Salvar Alterações</button>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Anotações</h3>
                            <div id="notes-container" class="space-y-3 mb-4 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-md">
                                ${client.notes && client.notes.length > 0 ? client.notes.map(note => `
                                    <div class="text-sm border-b border-gray-200 pb-2">
                                        <p class="text-gray-700">${note.text}</p>
                                        <p class="text-xs text-gray-400 mt-1">${note.date}</p>
                                    </div>
                                `).join('') : '<p class="text-sm text-gray-400">Nenhuma anotação.</p>'}
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="new-note-input" placeholder="Adicionar nova anotação..." class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                                <button id="add-note-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Adicionar</button>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-200 text-right">
                            <button id="delete-client-btn" class="text-sm text-red-600 hover:text-red-800 font-medium py-2 px-3 rounded-md hover:bg-red-50">Excluir Cliente</button>
                        </div>
                    </div>
                `;

                clientModal.classList.remove('hidden');
                setTimeout(() => {
                    clientModalContent.classList.remove('scale-95', 'opacity-0');
                    clientModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);

                document.getElementById('close-modal-btn').addEventListener('click', closeDetailsModal);
                document.getElementById('save-status-btn').addEventListener('click', () => saveClientData(clientId));
                document.getElementById('add-note-btn').addEventListener('click', () => addNote(clientId));
                document.getElementById('delete-client-btn').addEventListener('click', () => handleDeleteClient(clientId));
            };

            const closeDetailsModal = () => {
                clientModalContent.classList.add('scale-95', 'opacity-0');
                clientModalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    clientModal.classList.add('hidden');
                }, 300);
            };
            
            const openAddModal = () => {
                addClientModal.classList.remove('hidden');
                setTimeout(() => {
                    addClientModalContent.classList.remove('scale-95', 'opacity-0');
                    addClientModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            };

            const closeAddModal = () => {
                addClientForm.reset();
                addClientModalContent.classList.add('scale-95', 'opacity-0');
                addClientModalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    addClientModal.classList.add('hidden');
                }, 300);
            };

            const saveClientData = async (clientId) => {
                const clientDocRef = doc(db, "clients", clientId);
                const statusSelect = document.getElementById('status-select');
                try {
                    await updateDoc(clientDocRef, { status: statusSelect.value });
                    closeDetailsModal();
                } catch (e) {
                    console.error("Erro ao atualizar documento: ", e);
                    alert("Falha ao salvar. Tente novamente.");
                }
            };

            const addNote = async (clientId) => {
                const clientDocRef = doc(db, "clients", clientId);
                const noteInput = document.getElementById('new-note-input');
                const noteText = noteInput.value.trim();

                if (noteText) {
                    const newNote = { text: noteText, date: new Date().toLocaleString('pt-BR') };
                    try {
                        await updateDoc(clientDocRef, { notes: arrayUnion(newNote) });
                        noteInput.value = '';
                    } catch (e) {
                        console.error("Erro ao adicionar nota: ", e);
                        alert("Falha ao adicionar nota. Tente novamente.");
                    }
                }
            };
            
            const handleDeleteClient = (clientId) => {
                const deleteBtn = document.getElementById('delete-client-btn');
                const confirmationHtml = `
                    <p class="text-sm text-gray-800 mr-4">Tem certeza?</p>
                    <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-1 px-3 rounded-md hover:bg-red-700">Sim, Excluir</button>
                    <button id="cancel-delete-btn" class="text-sm text-gray-600 ml-2 py-1 px-3 rounded-md hover:bg-gray-200">Cancelar</button>
                `;
                deleteBtn.parentElement.innerHTML = confirmationHtml;

                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    try {
                        await deleteDoc(doc(db, "clients", clientId));
                        closeDetailsModal();
                    } catch (e) {
                        console.error("Erro ao excluir documento: ", e);
                        alert("Falha ao excluir. Tente novamente.");
                    }
                });
                document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                    openDetailsModal(clientId);
                });
            };
            
            const handleAddNewClient = async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-client-name').value.trim();
                if (!name) {
                    alert('O nome do cliente é obrigatório.');
                    return;
                }
                const newClient = {
                    name: name,
                    address: document.getElementById('new-client-address').value,
                    contact: document.getElementById('new-client-contact').value,
                    segment: document.getElementById('new-client-segment').value,
                    status: 'Não contatado',
                    notes: []
                };
                try {
                    await addDoc(clientsCollection, newClient);
                    closeAddModal();
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    alert("Falha ao adicionar cliente. Tente novamente.");
                }
            };
            
            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-details-btn')) {
                    const clientId = e.target.dataset.id;
                    openDetailsModal(clientId);
                }
            });
            
            clientModal.addEventListener('click', (e) => {
                if (e.target.id === 'client-modal') {
                    closeDetailsModal();
                }
            });
            
            addClientBtn.addEventListener('click', openAddModal);
            cancelAddBtn.addEventListener('click', closeAddModal);
            addClientModal.addEventListener('click', (e) => {
                 if (e.target.id === 'add-client-modal') {
                    closeAddModal();
                }
            });
            addClientForm.addEventListener('submit', handleAddNewClient);

            searchInput.addEventListener('input', renderTable);
            segmentFilter.addEventListener('change', renderTable);
        });
    </script>
</body>
</html>
