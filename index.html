<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Colaborativo - Silva Tintas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A3D62"/>
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-nao-contatado { background-color: #e2e8f0; color: #4a5568; }
        .status-contatado { background-color: #bee3f8; color: #2b6cb0; }
        .status-em-negociacao { background-color: #faf089; color: #975a16; }
        .status-cliente { background-color: #c6f6d5; color: #2f855a; }
        .status-perdido { background-color: #fed7d7; color: #c53030; }
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-[#0A3D62] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-600">A autenticar e carregar dados...</p>
        </div>
    </div>

    <div id="app" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                     <div class="bg-[#0A3D62] p-2 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </div>
                    <h1 class="text-2xl font-bold text-[#0A3D62]">CRM Colaborativo</h1>
                </div>
                <button id="add-client-btn" class="bg-[#0A3D62] text-white font-semibold py-2 px-4 rounded-md hover:bg-[#1E90FF] transition text-sm flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    <span class="hidden sm:inline">Adicionar Cliente</span>
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <section id="dashboard" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8"></section>
            <section class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                <div class="grid md:grid-cols-3 gap-4 items-center">
                    <div class="md:col-span-2">
                        <input type="text" id="search" placeholder="Buscar por nome do cliente..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#0A3D62] focus:border-transparent">
                    </div>
                    <div>
                        <select id="filter-segment" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-[#0A3D62] focus:border-transparent">
                            <option value="todos">Todos os Segmentos</option>
                            <option value="Reparação Automotiva">Reparação Automotiva</option>
                            <option value="Frotas e Veículos Pesados">Frotas e Veículos Pesados</option>
                            <option value="Indústria da Madeira e Mobiliário">Indústria da Madeira</option>
                            <option value="Indústria Metalmecânica e Construção">Indústria e Construção</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-sm overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider">Segmento</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-600 uppercase tracking-wider text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="client-table-body"></tbody>
                </table>
                 <div id="no-results" class="hidden text-center py-12 px-6">
                    <p class="text-gray-500">Nenhum cliente encontrado. Adicione o primeiro!</p>
                </div>
            </section>
        </main>

        <div id="client-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0"></div>
        </div>
        
        <div id="add-client-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="add-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg transform scale-95 opacity-0">
                <form id="add-client-form" class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Adicionar Novo Cliente</h2>
                        <button type="button" id="cancel-add-btn" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="new-client-name" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="new-client-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="new-client-address" class="block text-sm font-medium text-gray-700">Endereço</label>
                            <input type="text" id="new-client-address" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="new-client-contact" class="block text-sm font-medium text-gray-700">Contato (Telefone/Email)</label>
                            <input type="text" id="new-client-contact" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="new-client-segment" class="block text-sm font-medium text-gray-700">Segmento</label>
                            <select id="new-client-segment" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
                                <option value="Reparação Automotiva">Reparação Automotiva</option>
                                <option value="Frotas e Veículos Pesados">Frotas e Veículos Pesados</option>
                                <option value="Indústria da Madeira e Mobiliário">Indústria da Madeira</option>
                                <option value="Indústria Metalmecânica e Construção">Indústria e Construção</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="bg-[#0A3D62] text-white font-bold py-2 px-4 rounded-md hover:bg-[#1E90FF] transition">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- CONFIGURAÇÃO OBRIGATÓRIA DO FIREBASE ---
        // Insira aqui as chaves que copiou do seu projeto Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyDPisgGzruxqnXzf9hPlb05uCN3hMozt2s",
            authDomain: "crm-silva-tintas.firebaseapp.com",
            projectId: "crm-silva-tintas",
            storageBucket: "crm-silva-tintas.firebasestorage.app",
            messagingSenderId: "37152653096",
            appId: "1:37152653096:web:26343eee0a516de3abda1d",
            measurementId: "G-PM419Y78GD"
        };
        
        // ---- FIM DA CONFIGURAÇÃO ----

        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            let db, auth;
            let allClients = [];
            let openedClientId = null;
            let unsubscribe; // Para parar de ouvir updates quando não for preciso

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                loadingOverlay.innerHTML = `<div class='text-center p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md'><h3 class='font-bold text-red-600 text-lg'>Erro na Configuração do Firebase</h3><p class='text-gray-700 mt-2'>Verifique se copiou as chaves corretamente do site do Firebase.</p></div>`;
                return;
            }

            const appDiv = document.getElementById('app');
            const tableBody = document.getElementById('client-table-body');
            const searchInput = document.getElementById('search');
            const segmentFilter = document.getElementById('filter-segment');
            const dashboard = document.getElementById('dashboard');
            const clientModal = document.getElementById('client-modal');
            const clientModalContent = document.getElementById('modal-content');
            const addClientModal = document.getElementById('add-client-modal');
            const addClientModalContent = document.getElementById('add-modal-content');
            const addClientBtn = document.getElementById('add-client-btn');
            const addClientForm = document.getElementById('add-client-form');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const noResultsDiv = document.getElementById('no-results');

            const statusClasses = { "Não contatado": "status-nao-contatado", "Contatado": "status-contatado", "Em negociação": "status-em-negociacao", "Cliente": "status-cliente", "Perdido": "status-perdido" };
            const statusOrder = { "Não contatado": 1, "Contatado": 2, "Em negociação": 3, "Cliente": 4, "Perdido": 5 };
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    if (unsubscribe) unsubscribe(); // Cancela o listener anterior se existir
                    const clientsCollection = collection(db, "clients");
                    unsubscribe = onSnapshot(clientsCollection, (snapshot) => {
                        allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderTable();
                        renderDashboard();
                        if (openedClientId) {
                            const clientData = allClients.find(c => c.id === openedClientId);
                            clientData ? openDetailsModal(openedClientId, false) : closeDetailsModal();
                        }
                        loadingOverlay.classList.add('hidden');
                        appDiv.classList.remove('hidden');
                    }, (error) => {
                        loadingOverlay.innerHTML = `<div class='text-center p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md'><h3 class='font-bold text-red-600 text-lg'>Falha na Ligação</h3><p class='text-gray-700 mt-2'>Verifique se ativou o <strong>Cloud Firestore</strong> e atualizou as <strong>Regras de Segurança</strong> no seu projeto Firebase.</p></div>`;
                    });
                } else {
                    signInAnonymously(auth).catch(error => {
                        loadingOverlay.innerHTML = `<div class='text-center p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md'><h3 class='font-bold text-red-600 text-lg'>Falha na Autenticação</h3><p class='text-gray-700 mt-2'>Verifique se ativou o login <strong>"Anônimo"</strong> no painel de <strong>Authentication</strong> do Firebase.</p></div>`;
                    });
                }
            });

            const renderDashboard = () => {
                const total = allClients.length;
                const naoContatado = allClients.filter(c => c.status === 'Não contatado').length;
                const contatado = allClients.filter(c => c.status === 'Contatado').length;
                const emNegociacao = allClients.filter(c => c.status === 'Em negociação').length;
                const cliente = allClients.filter(c => c.status === 'Cliente').length;
                dashboard.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-2xl font-bold text-[#0A3D62]">${total}</p><p class="text-sm text-gray-500">Total</p></div><div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-2xl font-bold text-gray-600">${naoContatado}</p><p class="text-sm text-gray-500">Não Contatados</p></div><div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-2xl font-bold text-blue-600">${contatado}</p><p class="text-sm text-gray-500">Contatados</p></div><div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-2xl font-bold text-yellow-600">${emNegociacao}</p><p class="text-sm text-gray-500">Em Negociação</p></div><div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-2xl font-bold text-green-600">${cliente}</p><p class="text-sm text-gray-500">Clientes</p></div>`;
            };

            const renderTable = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedSegment = segmentFilter.value;
                const filteredClients = allClients.filter(client => (client.name.toLowerCase().includes(searchTerm)) && (selectedSegment === 'todos' || client.segment === selectedSegment));
                tableBody.innerHTML = '';
                noResultsDiv.classList.toggle('hidden', filteredClients.length > 0);
                filteredClients.sort((a, b) => statusOrder[a.status] - statusOrder[b.status] || a.name.localeCompare(b.name)).forEach(client => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap"><p class="font-semibold text-gray-900">${client.name}</p><p class="text-sm text-gray-500">${client.address ? client.address.split(',').pop().trim() : ''}</p></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${client.segment}</td><td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusClasses[client.status]}">${client.status}</span></td><td class="px-6 py-4 whitespace-nowrap text-right"><button data-id="${client.id}" class="view-details-btn text-sm font-medium text-[#0A3D62] hover:text-[#1E90FF]">Detalhes</button></td>`;
                    tableBody.appendChild(row);
                });
            };

            const openDetailsModal = (clientId, animate = true) => {
                openedClientId = clientId;
                const client = allClients.find(c => c.id === clientId);
                if (!client) return;
                clientModalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-start mb-4"><div><h2 class="text-2xl font-bold text-gray-900">${client.name}</h2><p class="text-sm text-gray-500">${client.address || ''}</p><p class="text-sm text-gray-500">${client.contact || ''}</p></div><button id="close-modal-btn" class="p-1 rounded-full hover:bg-gray-200">&times;</button></div><div class="grid md:grid-cols-2 gap-6 mb-6"><div><label for="status-select" class="block text-sm font-medium text-gray-700 mb-1">Status</label><select id="status-select" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"><option value="Não contatado" ${client.status === 'Não contatado' ? 'selected' : ''}>Não contatado</option><option value="Contatado" ${client.status === 'Contatado' ? 'selected' : ''}>Contatado</option><option value="Em negociação" ${client.status === 'Em negociação' ? 'selected' : ''}>Em negociação</option><option value="Cliente" ${client.status === 'Cliente' ? 'selected' : ''}>Cliente</option><option value="Perdido" ${client.status === 'Perdido' ? 'selected' : ''}>Perdido</option></select></div><div class="self-end"><button id="save-status-btn" class="w-full bg-[#0A3D62] text-white font-bold py-2 px-4 rounded-md hover:bg-[#1E90FF] transition">Salvar Alterações</button></div></div><div><h3 class="text-lg font-semibold text-gray-800 mb-2">Anotações</h3><div id="notes-container" class="space-y-3 mb-4 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-md">${client.notes && client.notes.length > 0 ? [...client.notes].reverse().map(note => `<div class="text-sm border-b border-gray-200 pb-2"><p class="text-gray-700">${note.text}</p><p class="text-xs text-gray-400 mt-1">${note.date}</p></div>`).join('') : '<p class="text-sm text-gray-400">Nenhuma anotação.</p>'}</div><div class="flex gap-2"><input type="text" id="new-note-input" placeholder="Adicionar nova anotação..." class="flex-grow px-3 py-2 border border-gray-300 rounded-md"><button id="add-note-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Adicionar</button></div></div><div class="mt-6 pt-4 border-t border-gray-200 text-right"><button id="delete-client-btn" class="text-sm text-red-600 hover:text-red-800 font-medium py-2 px-3 rounded-md hover:bg-red-50">Excluir Cliente</button></div></div>`;
                clientModal.classList.remove('hidden');
                if (animate) setTimeout(() => clientModalContent.classList.remove('scale-95', 'opacity-0'), 10);
                else clientModalContent.classList.remove('scale-95', 'opacity-0');
                document.getElementById('close-modal-btn').addEventListener('click', closeDetailsModal);
                document.getElementById('save-status-btn').addEventListener('click', () => saveClientData(clientId));
                document.getElementById('add-note-btn').addEventListener('click', () => addNote(clientId));
                document.getElementById('delete-client-btn').addEventListener('click', () => handleDeleteClient(clientId));
            };

            const closeDetailsModal = () => { openedClientId = null; clientModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => clientModal.classList.add('hidden'), 300); };
            const openAddModal = () => { addClientModal.classList.remove('hidden'); setTimeout(() => addClientModalContent.classList.remove('scale-95', 'opacity-0'), 10); };
            const closeAddModal = () => { addClientForm.reset(); addClientModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => addClientModal.classList.add('hidden'), 300); };

            const saveClientData = async (clientId) => { await updateDoc(doc(db, "clients", clientId), { status: document.getElementById('status-select').value }); closeDetailsModal(); };
            const addNote = async (clientId) => {
                const noteInput = document.getElementById('new-note-input');
                if (noteInput.value.trim()) {
                    const newNote = { text: noteInput.value.trim(), date: new Date().toLocaleString('pt-BR') };
                    await updateDoc(doc(db, "clients", clientId), { notes: arrayUnion(newNote) });
                }
            };
            
            const handleDeleteClient = (clientId) => {
                const deleteBtn = document.getElementById('delete-client-btn');
                deleteBtn.parentElement.innerHTML = `<p class="text-sm text-gray-800 mr-4">Tem certeza?</p><button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-1 px-3 rounded-md hover:bg-red-700">Sim</button><button id="cancel-delete-btn" class="text-sm text-gray-600 ml-2 py-1 px-3 rounded-md hover:bg-gray-200">Cancelar</button>`;
                document.getElementById('confirm-delete-btn').addEventListener('click', async () => { await deleteDoc(doc(db, "clients", clientId)); closeDetailsModal(); });
                document.getElementById('cancel-delete-btn').addEventListener('click', () => openDetailsModal(clientId, false));
            };
            
            const handleAddNewClient = async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-client-name').value.trim();
                if (!name) return;
                await addDoc(collection(db, "clients"), { name: name, address: document.getElementById('new-client-address').value, contact: document.getElementById('new-client-contact').value, segment: document.getElementById('new-client-segment').value, status: 'Não contatado', notes: [], createdAt: serverTimestamp() });
                closeAddModal();
            };
            
            tableBody.addEventListener('click', (e) => e.target.classList.contains('view-details-btn') && openDetailsModal(e.target.dataset.id));
            clientModal.addEventListener('click', (e) => e.target.id === 'client-modal' && closeDetailsModal());
            addClientBtn.addEventListener('click', openAddModal);
            cancelAddBtn.addEventListener('click', closeAddModal);
            addClientModal.addEventListener('click', (e) => e.target.id === 'add-client-modal' && closeAddModal());
            addClientForm.addEventListener('submit', handleAddNewClient);
            searchInput.addEventListener('input', renderTable);
            segmentFilter.addEventListener('change', renderTable);
        });
    </script>
</body>
</html>
